æ–¹æ¡ˆ Aï¼šç”¨åŒä¸€å€‹ Chrome ä½¿ç”¨è€…è³‡æ–™å¤¾ï¼ˆæœ€ç°¡å–®ã€æœ€ç©©ï¼‰
è§€å¿µï¼šè®“ ChromeDriver å•Ÿå‹•çš„ Chrome ç›´æ¥ä½¿ç”¨ä½ å¹³å¸¸ä¸Šç¶²ç”¨çš„ profileï¼Œç­‰åŒã€ŒåŒä¸€å€‹äººã€åŒä¸€å¥—ç€è¦½å™¨ã€ï¼Œè‡ªç„¶å°±å¸¶è‘— Teams çš„ cookie/Token/LocalStorageã€‚

ç”¨é€™å€‹ profile å•Ÿå‹• ChromeDriverï¼š
-------------------------------------
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

options = Options()
options.add_argument(r'--user-data-dir=C:\Users\ä½ çš„å¸³è™Ÿ\AppData\Local\Google\Chrome\User Data')
options.add_argument(r'--profile-directory=Default')  # æˆ– "Profile 1"
# å¯é¸ï¼šé¿å…è‡ªå‹•åŒ–æ©«å¹…ï¼Œç©©å®šæ€§å¾®å¹…æå‡
options.add_experimental_option("excludeSwitches", ["enable-automation"])
options.add_experimental_option('useAutomationExtension', False)

driver = webdriver.Chrome(options=options)
driver.get("https://teams.microsoft.com/")   # æˆ–æ–°ç‰ˆ v2ï¼š https://teams.microsoft.com/v2/
-----------------------------------
æ³¨æ„äº‹é …

çµ•å°ä¸è¦åŒæ™‚ç”¨åŒä¸€å€‹ profile åœ¨ã€Œæ‰‹å‹• Chromeã€å’Œã€ŒSeleniumã€å…©é‚Šé–‹å•Ÿï¼Œæœƒé–æª”æ¡ˆå°è‡´å•Ÿå‹•å¤±æ•—æˆ–è³‡æ–™ææ¯€ã€‚

å»ºè­°å…ˆæŠŠä½ çš„å¸¸ç”¨ profile è¤‡è£½ä¸€ä»½åšã€Œè‡ªå‹•åŒ–å°ˆç”¨ã€ï¼š
ä¾‹å¦‚è¤‡è£½ Default â†’ Default_Auto; ç„¶å¾ŒæŠŠ --profile-directory=Default_Auto æŒ‡çµ¦ Seleniumã€‚

Teams æ‰€éœ€çš„ç¬¬ä¸‰æ–¹ Cookieï¼ˆä¾‹å¦‚ login.microsoftonline.comï¼‰å¦‚æœè¢«å°é–ï¼Œç™»å…¥æœƒå¤±æ•—ï¼›è«‹ç¢ºèª Chrome è¨­å®šå…è¨±ï¼ˆæˆ–é‡å°è©²ç¶²åŸŸæ”¾è¡Œï¼‰ã€‚

å…¬å¸æœ‰ MFA / CAï¼ˆæ¢ä»¶å¼å­˜å–ï¼‰/ è£ç½®ç›¸å®¹æ€§æ”¿ç­– æ™‚ï¼Œå³ä½¿å¸¶è‘—èˆŠ sessionï¼Œä¹Ÿå¯èƒ½è¢«è¦æ±‚é‡æ–°é©—è­‰ã€‚






æ–¹æ¡ˆ Bï¼šé™„è‘—åˆ°å·²é–‹å•Ÿã€å·²ç™»å…¥çš„ Chromeï¼ˆä¸é—œç€è¦½å™¨ï¼‰

è§€å¿µï¼šå…ˆæ‰‹å‹•é–‹ä¸€å€‹ Chromeï¼ˆå·²ç™»å…¥ Teamsï¼‰ï¼Œç”¨ --remote-debugging-port é–‹å•Ÿ DevTools ä¼ºæœå™¨ï¼›Selenium å†ç”¨åŒå€‹ profile é™„è‘—ï¼ˆattachï¼‰ é€²å»ã€‚é€™æ¨£ä½ ä¸ç”¨é—œæ‰åŸæœ¬çš„ Chromeï¼Œä¹Ÿèƒ½ç”¨å®ƒçš„ sessionã€‚

æ­¥é©Ÿ

å…ˆé—œé–‰æ‰€æœ‰ Chromeã€‚

ç”¨å‘½ä»¤åˆ—æ‰‹å‹•å•Ÿå‹•ï¼ˆå¡«ä½ çš„è·¯å¾‘èˆ‡ profileï¼‰ï¼š
-----------------------
"C:\Program Files\Google\Chrome\Application\chrome.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="C:\Users\ä½ çš„å¸³è™Ÿ\AppData\Local\Google\Chrome\User Data" ^
  --profile-directory="Default"
------------------------------------

é€™å€‹ Chrome é–‹èµ·ä¾†å¾Œï¼Œå…ˆæ‰‹å‹•ç™»å…¥ Teams ä¸€æ¬¡ç¢ºèª OKã€‚

Selenium ç«¯é™„è‘—åˆ° 9222ï¼š

from selenium import webdriver
from selenium.webdriver.chrome.options import Options

options = Options()
options.add_experimental_option("debuggerAddress", "127.0.0.1:9222")
driver = webdriver.Chrome(options=options)
----------------------------------------------------
# é€™æ™‚å·²ç¶“å…±ç”¨åŒä¸€å€‹ session / å„²å­˜é«”
driver.get("https://teams.microsoft.com/")


å„ªé»ï¼šä¸æœƒç¢°åˆ°ã€Œprofile æ­£åœ¨ä½¿ç”¨ä¸­ã€çš„é–ï¼›æ²¿ç”¨å®Œæ•´ç™»å…¥ç‹€æ…‹ï¼ˆcookieã€LocalStorageã€IndexedDBâ€¦ï¼‰ã€‚
ç¼ºé»ï¼šéœ€è¦ä½ å…ˆç”¨è©²åƒæ•¸å•Ÿå‹• Chromeã€‚

æ’éŒ¯æ¸…å–®ï¼ˆå‹™å¿…ç¢ºèªï¼‰

ç‰ˆæœ¬ç›¸å®¹ï¼šChromeDriver ä¸»ç‰ˆè™Ÿè¦è·Ÿæœ¬æ©Ÿ Chrome ä¸€è‡´ï¼ˆä¾‹å¦‚éƒ½ 128ï¼‰ã€‚

é—œé–‰è¡çªï¼šè‹¥èµ°æ–¹æ¡ˆ Aï¼Œå•Ÿå‹•å‰è«‹é—œé–‰æ‰€æœ‰ Chromeï¼›æˆ–æ”¹èµ°æ–¹æ¡ˆ Bã€‚

æ”¿ç­–é™åˆ¶ï¼šå…¬å¸ GPO å¯èƒ½ç¦æ­¢è‡ªå‹•åŒ–ã€é™åˆ¶ç¬¬ä¸‰æ–¹ cookieã€æˆ–å¼·åˆ¶çŸ­ç™»å…¥æ™‚æ•ˆï¼ˆSign-in frequencyï¼‰ï¼Œé€™äº› Selenium æ”¹ä¸äº†ã€‚

MFA/SSOï¼šéœ€è¦äºŒæ¬¡é©—è­‰æ™‚ï¼Œä»»ä½•ã€Œæ²¿ç”¨ cookieã€æ–¹æ³•éƒ½ç„¡æ³•ã€Œç¹éã€é©—è­‰ï¼Œåªèƒ½åœ¨äººç‚ºå®Œæˆå¾Œæ²¿ç”¨ sessionã€‚

Headlessï¼šæ–° headlessï¼ˆ--headless=newï¼‰å¤§å¤šå¯ç”¨ï¼Œä½†æ“´å……å¥—ä»¶ä¸æœƒè¼‰å…¥ï¼›è‹¥ Teams ç™»å…¥ä»°è³´æŸæ“´å……å¥—ä»¶ï¼ˆç½•è¦‹ï¼‰ï¼Œè«‹ç”¨é headlessã€‚


å°çµ

å¯ä»¥é€é Selenium ç›´æ¥æ²¿ç”¨ä½  Chrome å·²ç™»å…¥çš„ç‹€æ…‹ï¼Œæœ€æ¨è–¦ æ–¹æ¡ˆ Aï¼ˆåŒ profileï¼‰ æˆ– æ–¹æ¡ˆ Bï¼ˆé™„è‘—åˆ°å·²ç™»å…¥çš„ Chromeï¼‰ã€‚

å–®ç´”ã€Œå¡ cookieã€å¸¸å¸¸ä¸å¤ ï¼Œå› ç‚º Teams æœƒç”¨åˆ°æ›´å¤šç€è¦½å™¨å„²å­˜æ©Ÿåˆ¶ã€‚

è‹¥ä½ é‡åˆ°å…¬å¸æ”¿ç­–/MFAï¼Œè¦å…ˆåœ¨äººç‚ºæµç¨‹å®Œæˆå¾Œå†æ²¿ç”¨ sessionã€‚

éœ€è¦æˆ‘å¹«ä½ å¯«ä¸€å€‹ã€Œä¸€éµåµæ¸¬ä½ çš„ Chrome profile ä¸¦ç”¨å®ƒé–‹ Teams çš„ Selenium ç¯„ä¾‹ã€å—ï¼Ÿæˆ‘å¯ä»¥æŠŠ Windows å¸¸è¦‹è·¯å¾‘ã€è‡ªå‹•åµæ¸¬ Default/Profile 1 çš„é‚è¼¯éƒ½åŒ…å¥½çµ¦ä½ ç”¨ã€‚


-----------------------------------------------------------

åšæ³•ï¼šé™„è‘—åˆ°å·²ç™»å…¥çš„ Chromeï¼ˆremoteâ€‘debuggingï¼‰

å…ˆç”¨ä½ çš„ã€Œå¹³å¸¸é‚£å€‹å·²ç™»å…¥ Teams çš„ Chrome å€‹äººè³‡æ–™ã€å•Ÿå‹•ä¸€å€‹ Chromeï¼Œé–‹å•Ÿ DevTools é€£æ¥åŸ ã€‚

Selenium ç”¨ debuggerAddress é€£ä¸Šé‚£å€‹ Chromeï¼Œå› æ­¤å®Œæ•´æ²¿ç”¨è©²å€‹äººè³‡æ–™çš„ç™»å…¥ï¼ˆcookiesã€LocalStorageã€IndexedDBâ€¦ï¼‰ã€‚

ä¸€æ¬¡æ€§è¨­å®šï¼ˆWindowsï¼‰

å»ºç«‹ä¸€å€‹æ·å¾‘æˆ– .bat ä¾†å•Ÿå‹• Chromeï¼š

"C:\Program Files\Google\Chrome\Application\chrome.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="C:\Users\<ä½ çš„å¸³è™Ÿ>\AppData\Local\Google\Chrome\User Data" ^
  --profile-directory="Default"


æŠŠ <ä½ çš„å¸³è™Ÿ> èˆ‡ Default æ›æˆä½ å¯¦éš›ç”¨çš„ Profileã€‚å…ˆç”¨é€™å€‹è¦–çª—æ‰‹å‹•æ‰“é–‹ https://teams.microsoft.com/
 ç™»å…¥ä¸€æ¬¡å³å¯ã€‚

-------------------------------------------------------

Selenium ç¯„ä¾‹ï¼šå°é »é“æˆ–ç§èŠç™¼è¨Šæ¯

ä¸‹é¢æä¾›å…©å€‹å…¥å£æ–¹å¼ï¼Œé¸ä½ æ–¹ä¾¿çš„ç”¨ï¼š

A. é »é“è¨Šæ¯ï¼ˆå·²çŸ¥ teamId/channelIdï¼‰ï¼šç”¨ Teams deep link ç›´æ¥åˆ°æŒ‡å®šé »é“

B. ç§èŠ/å¤šäººèŠå¤©ï¼šç”¨ l/chat deep link æŒ‡å®šæ”¶ä»¶è€…ï¼ˆemailï¼‰

å…©è€…éƒ½ä½¿ç”¨ Teams Web App å…§éƒ¨çš„å¯ç·¨è¼¯è¼¸å…¥æ¡†ï¼š[contenteditable="true"][role="textbox"]ï¼Œé€å‡ºç”¨ Keys.ENTERã€‚

from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
import time

DEBUGGER = "127.0.0.1:9222"  # è¦è·Ÿä½ å•Ÿå‹• Chrome çš„åŸ ä¸€è‡´
TEAMS_BASE = "https://teams.microsoft.com/"

def attach_driver():
    opts = Options()
    opts.add_experimental_option("debuggerAddress", DEBUGGER)
    # è®“è‡ªå‹•åŒ–æ©«å¹…æ¶ˆå¤±ï¼Œç©©å®šæ€§ç¨å¥½
    opts.add_experimental_option("excludeSwitches", ["enable-automation"])
    opts.add_experimental_option("useAutomationExtension", False)
    driver = webdriver.Chrome(options=opts)
    driver.implicitly_wait(0)  # å…¨éƒ¨ç”¨é¡¯å¼ç­‰å¾…
    return driver

def wait_compose_box(driver, timeout=30):
    # ç­‰å¾…è¨Šæ¯è¼¸å…¥æ¡†ï¼ˆcontenteditable textboxï¼‰å¯äº’å‹•
    box = WebDriverWait(driver, timeout).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, '[contenteditable="true"][role="textbox"]'))
    )
    # æœ‰äº›ç‰ˆé¢æœƒæœ‰å…©å€‹ textboxï¼ˆæœå°‹ + è¼¸å…¥æ¡†ï¼‰ï¼ŒæŒ‘å¯è¦‹ä¸”åœ¨ç•«é¢å…§çš„
    if isinstance(box, list):
        box = [b for b in box if b.is_displayed()][0]
    return box

def send_message(driver, text, newline=False):
    box = wait_compose_box(driver, timeout=40)
    box.click()
    # è¼¸å…¥å…§å®¹ï¼ˆé•·è¨Šæ¯å¯åˆ†æ®µé€ï¼‰
    for line in text.split("\n"):
        box.send_keys(line)
        if newline:
            box.send_keys(Keys.SHIFT, Keys.ENTER)  # ä¿ç•™æ›è¡Œ
            box.send_keys(Keys.NULL)               # é‡‹æ”¾ä¿®é£¾éµ
    # é€å‡º
    box.send_keys(Keys.ENTER)
    # ç°¡å–®ç¢ºèªï¼šç­‰å¾…è¨Šæ¯æ³¡æ³¡å‡ºç¾ï¼ˆé¿å…ç«‹å³è·³é å°è‡´æœªé€å‡ºï¼‰
    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '[data-tid="messageItemBody"]'))
    )

def open_channel(driver, team_id, channel_id, tenant_id=None):
    # æ–°ç‰ˆæ·±é€£çµï¼ˆèˆŠç‰ˆä¹Ÿå¯ï¼‰ï¼šl/channel/{channelId}/...
    # åç¨±åƒæ•¸å¯ç•™ç©ºï¼›æœ€é—œéµæ˜¯ teamId èˆ‡ channelId
    url = f"https://teams.microsoft.com/l/channel/{channel_id}/?groupId={team_id}"
    if tenant_id:
        url += f"&tenantId={tenant_id}"
    driver.get(url)
    # ç­‰å¾…é »é“è¨Šæ¯ä¸²è¼‰å…¥
    WebDriverWait(driver, 60).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '[data-tid="channel-conversation"]'))
    )

def open_chat_with_users(driver, user_emails_csv):
    # å–®äººæˆ–å¤šäººç§èŠï¼ˆä»¥ email å»ºå»ºç«‹å°è©±ï¼‰
    # ä¾‹ï¼š"a@contoso.com" æˆ– "a@contoso.com,b@contoso.com"
    url = f"https://teams.microsoft.com/l/chat/0/0?users={user_emails_csv}"
    driver.get(url)
    # ç­‰å¾…èŠå¤©è¼‰å…¥
    WebDriverWait(driver, 60).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '[data-tid="chat-list"]'))
    )

if __name__ == "__main__":
    driver = attach_driver()

    # === é¸æ“‡å…¶ä¸€ï¼šé–‹å•Ÿé »é“ ===
    # open_channel(driver, team_id="xxxxx-xxxx-xxxx", channel_id="yyyyy-yyyy", tenant_id="zzzzz-zzz")
    # send_message(driver, "æ—©å®‰ï¼é€™æ˜¯ Selenium ç¶­é‹è¨Šæ¯ âœ…", newline=False)

    # === æˆ–ï¼šé–‹å•Ÿç§èŠ / å¤šäººèŠå¤© ===
    open_chat_with_users(driver, "user1@yourorg.com,user2@yourorg.com")
    send_message(driver, "æ’ç¨‹æé†’ï¼š10:00 ä¾‹æœƒï¼Œè«‹æº–æ™‚ä¸Šç·š ğŸ™Œ", newline=False)

    # è¦–éœ€è¦ä¿ç•™é é¢æ•¸ç§’
    time.sleep(2)

å°é‡é»èˆ‡æ’éŒ¯

ä¸è¦åŒæ™‚ç”¨åŒä¸€å€‹ Profile è·‘ä¸€èˆ¬ Chrome èˆ‡å¦ä¸€å€‹ Selenium é€£ç·šï¼ˆç”¨ã€Œé™„è‘—ã€æ³•å°±åªæœƒæœ‰ä¸€å€‹å¯¦é«” Chromeï¼‰ã€‚

ç¬¬ä¸€æ¬¡ç™»å…¥æˆ–é‡åˆ° MFA/é‡æ–°é©—è­‰ï¼Œè«‹åœ¨ä½ æ‰‹å‹•é–‹çš„é‚£å€‹ Chrome è¦–çª—å®Œæˆï¼›ä¹‹å¾Œ Selenium å°±èƒ½æ²¿ç”¨ sessionã€‚

RDP æœ€å°åŒ–/é–è¢å¹•ï¼šæ­¤æ³•ä»æ˜¯ã€Œæœ‰é ­ã€Chromeï¼Œåœ¨æ¥µç«¯ç’°å¢ƒå¯èƒ½å—å½±éŸ¿ï¼›è‹¥æ©Ÿå™¨æœƒé–è¢å¹•ï¼Œå»ºè­°æŠŠè§¸ç™¼è…³æœ¬æ”¾åœ¨å¯¦é«”æˆ–å°ˆç”¨ VMä¸Šï¼Œä¸¦ç¢ºä¿å·¥ä½œæ’ç¨‹åœ¨è§£é–æ™‚æ®µåŸ·è¡Œï¼Œæˆ–ä¿®æ”¹é›»æº/è¢å¹•æ”¿ç­–ï¼ˆè‹¥å…¬å¸å…è¨±ï¼‰ã€‚

é¸æ“‡å™¨å¯èƒ½è®Šå‹•ï¼šæˆ‘ç”¨çš„æ˜¯ç©©å®šåº¦è¼ƒé«˜çš„å±¬æ€§é¸æ“‡ï¼ˆrole="textbox", data-tidï¼‰ï¼›ä½† Teams Web UI æ›´æ–°ä»å¯èƒ½è®Šã€‚è‹¥æ‰¾ä¸åˆ°è¼¸å…¥æ¡†ï¼Œå„ªå…ˆç”¨ contenteditable="true" + role="textbox" çš„çµ„åˆå†åŠ  :focus åˆ¤æ–·ã€‚

æ·±é€£çµå¥½ç”¨ï¼š

é »é“ï¼š/l/channel/{channelId}/?groupId={teamId}&tenantId={tenantId}

ç§èŠï¼š/l/chat/0/0?users=user1@org.com,user2@org.com
æ·±é€£çµå¯å°‘èµ°å¾ˆå¤š UI é»æ“Šï¼Œå¤§å¹…æé«˜ç©©å®šåº¦ã€‚

Chrome ç‰ˆæœ¬å°æ‡‰ï¼šChromeDriver ä¸»ç‰ˆè™Ÿè¦èˆ‡ Chrome ä¸€è‡´ï¼ˆä¾‹å¦‚éƒ½ 128ï¼‰ã€‚

æ–‡å­—æ›è¡Œï¼šsend_message(..., newline=True) æœƒç”¨ Shift+Enter ç”¢ç”Ÿæ®µè½å…§æ›è¡Œï¼Œå†æœ€å¾Œ Enter é€å‡ºã€‚

æƒ³æ’ç¨‹è‡ªå‹•é€ï¼Ÿ

ä½ å¯ä»¥æŠŠ å•Ÿå‹• Chromeï¼ˆå« remoteâ€‘debuggingï¼‰ æ”¾åœ¨ç™»å…¥å•Ÿå‹•é …æˆ–å·¥ä½œæ’ç¨‹å™¨é–‹æ©Ÿå•Ÿå‹•ï¼›

å†ç”¨å·¥ä½œæ’ç¨‹å™¨å®šæ™‚å‘¼å«ä½ çš„ Python è…³æœ¬ï¼ˆä¸Šé¢ if __name__ == "__main__": é‚£æ®µï¼‰ã€‚

å¦‚æœä½ å·²ç¶“æœ‰ teamId / channelId æˆ–æ”¶ä»¶è€… email æ¸…å–®ï¼Œæˆ‘å¯ä»¥å¹«ä½ æŠŠä¸Šé¢è…³æœ¬çš„ã€Œä¸»ç¨‹å¼æ®µã€æ”¹æˆè®€å– .env æˆ– JSON æ‰¹æ¬¡ç™¼é€ï¼ˆå«é‡è©¦èˆ‡é€é”æª¢æŸ¥ï¼‰ã€‚ä½ åªè¦è²¼ ID æˆ– email æ¸…å–®å°±è¡Œã€‚

---------------------------------------------------

äº†è§£ï¼ä½ é›»è…¦ä¸Šå·²å®‰è£ Teams æ¡Œé¢ç‰ˆï¼Œä½†ä½ ç¾åœ¨çš„éœ€æ±‚æ˜¯ï¼šåªèƒ½ç”¨ Seleniumï¼Œä¸¦æ²¿ç”¨å·²ç™»å…¥çš„ Chrome ç‹€æ…‹ï¼Œè‡ªå‹•åœ¨ Teams ç™¼è¨Šæ¯ã€‚
é‡é»æ˜¯ï¼šSelenium åªèƒ½æ§åˆ¶ç€è¦½å™¨ï¼Œç„¡æ³•ç›´æ¥æ“æ§ Teams æ¡Œé¢ appï¼ˆé‚£æ˜¯æ¡Œé¢ UIï¼Œè‡ªå‹•åŒ–è¦ç”¨ WinAppDriver/pywinauto ä¹‹é¡ï¼Œå’Œä½ æ¢ä»¶è¡çªï¼‰ã€‚
æ‰€ä»¥æˆ‘å€‘è¦å¼·åˆ¶ä½¿ç”¨ Teams çš„ Web ç‰ˆï¼Œè€Œä¸æ˜¯è¢«è‡ªå‹•å¸¶å»æ¡Œé¢ appã€‚

ä¸‹é¢çµ¦ä½ ä¸€å¥—ç©©å®šæµç¨‹ï¼ˆå¯ç›´æ¥ç”¨ï¼‰ï¼š

ä¸€æ¬¡æ€§è¨­å®šï¼ˆè®“ Chrome ä¿æŒæ—¢æœ‰ç™»å…¥ & å¯è¢« Selenium é™„è‘—ï¼‰

ç”¨ä½ çš„ Teams å·²ç™»å…¥çš„ Chrome å€‹äººè³‡æ–™å•Ÿå‹•ä¸€å€‹ Chromeï¼Œé–‹ DevTools é€£æ¥åŸ ï¼ˆåˆ¥é—œæ‰å®ƒï¼‰ï¼š
å»ºç«‹ä¸€å€‹ .batï¼ˆæˆ–æ·å¾‘ï¼‰ï¼š

"C:\Program Files\Google\Chrome\Application\chrome.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="C:\Users\<ä½ çš„å¸³è™Ÿ>\AppData\Local\Google\Chrome\User Data" ^
  --profile-directory="Default"


æŠŠ <ä½ çš„å¸³è™Ÿ> / Default æ›æˆä½ å¯¦éš› profileã€‚
ç”¨é€™å€‹è¦–çª—å…ˆæ‰‹å‹•é–‹ä¸€æ¬¡ https://teams.microsoft.com/?clientType=web ç¢ºèªå·²ç™»å…¥ï¼ˆä¹‹å¾Œå°±æ²¿ç”¨é€™å€‹ sessionï¼‰ã€‚

ç‚ºä»€éº¼ä¸€å®šç”¨ ?clientType=webï¼š
å³ä¾¿ä½ é›»è…¦æœ‰æ¡Œé¢ç‰ˆï¼Œé€™å€‹åƒæ•¸èƒ½å¼·åˆ¶èµ° Web ç‰ˆï¼Œé¿å…å‡ºç¾ã€ŒOpen Microsoft Teamsï¼ˆè¦ä¸è¦ç”¨æ¡Œé¢ app é–‹ï¼‰ã€çš„è·³è½‰å½ˆçª—ã€‚

-------------------------------------

Selenium è…³æœ¬ï¼ˆæ²¿ç”¨å·²ç™»å…¥çš„ Chrome + ç™¼è¨Šæ¯ï¼‰

æä¾›å…©å€‹å…¥å£ï¼š

ç™¼åˆ°é »é“ï¼ˆå·²çŸ¥ teamId + channelIdï¼‰

ç™¼ç§èŠ/å¤šäººèŠå¤©ï¼ˆç”¨ email deep linkï¼‰

from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
import time

DEBUGGER = "127.0.0.1:9222"  # èˆ‡ä½ å•Ÿå‹• Chrome çš„åŸ ä¸€è‡´
BASE = "https://teams.microsoft.com/?clientType=web"  # å¼·åˆ¶ä½¿ç”¨ Web ç‰ˆ

def attach_driver():
    opts = Options()
    opts.add_experimental_option("debuggerAddress", DEBUGGER)
    opts.add_experimental_option("excludeSwitches", ["enable-automation"])
    opts.add_experimental_option("useAutomationExtension", False)
    d = webdriver.Chrome(options=opts)
    d.implicitly_wait(0)
    return d

def wait_compose_box(driver, timeout=40):
    # Web ç‰ˆçš„è¼¸å…¥æ¡†ï¼šcontenteditable + role="textbox"
    return WebDriverWait(driver, timeout).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, '[contenteditable="true"][role="textbox"]'))
    )

def send_message(driver, text):
    box = wait_compose_box(driver)
    box.click()
    for line in text.split("\n"):
        box.send_keys(line)
        box.send_keys(Keys.SHIFT, Keys.ENTER)  # ä¿ç•™æ›è¡Œ
        box.send_keys(Keys.NULL)
    # é€å‡º
    box.send_keys(Keys.ENTER)
    # ç°¡å–®é€é”æª¢æŸ¥ï¼šè¨Šæ¯æ³¡æ³¡å‡ºç¾
    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '[data-tid="messageItemBody"]'))
    )

def open_channel(driver, team_id, channel_id, tenant_id=None):
    url = f"https://teams.microsoft.com/l/channel/{channel_id}/?groupId={team_id}&clientType=web"
    if tenant_id:
        url += f"&tenantId={tenant_id}"
    driver.get(url)
    WebDriverWait(driver, 60).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '[data-tid="channel-conversation"]'))
    )

def open_chat_with_users(driver, user_emails_csv):
    # å–®äººæˆ–å¤šäººç§èŠï¼šä»¥ email å»ºç«‹å°è©±
    url = f"https://teams.microsoft.com/l/chat/0/0?users={user_emails_csv}&clientType=web"
    driver.get(url)
    WebDriverWait(driver, 60).until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '[data-tid="chat-list"]'))
    )

if __name__ == "__main__":
    driver = attach_driver()

    # ã€é¸ä¸€ç¨®ç”¨æ³•ã€‘

    # A) ç™¼åˆ°é »é“
    # open_channel(driver, team_id="xxxxx-xxxx-xxxx-xxxx", channel_id="yyyyy-yyyy-yyyy-yyyy", tenant_id="zzzzz-zzzz-zzzz-zzzz")
    # send_message(driver, "âœ… Web ç‰ˆè¨Šæ¯æ¸¬è©¦ï¼šå¤§å®¶æ—©å®‰ï¼")

    # B) ç™¼ç§èŠ/å¤šäººèŠå¤©ï¼ˆç”¨é€—è™Ÿåˆ†éš” emailï¼‰
    open_chat_with_users(driver, "user1@yourorg.com,user2@yourorg.com")
    send_message(driver, "æ’ç¨‹æé†’ï¼š10:00 ä¾‹è¡Œæœƒè­°ï¼Œè«‹æº–æ™‚ä¸Šç·š ğŸ™Œ")

    time.sleep(1)

å¸¸è¦‹å‘ä½ & è§£æ³•

è¢«å¸¶å»æ¡Œé¢ appï¼šURL ä¸€å¾‹åŠ  ?clientType=webï¼›è‹¥ä»å½ˆã€ŒOpen Microsoft Teamsã€å°è©±ï¼Œé¸ã€Œç¹¼çºŒä½¿ç”¨ç¶²é ç‰ˆã€ï¼ˆæœƒè¨˜ä½åå¥½ï¼‰ã€‚

å…¬å¸ç”¨ SSO/MFAï¼šç¬¬ä¸€æ¬¡è¦åœ¨ä½ æ‰‹å‹•é–‹çš„é‚£å€‹ Chrome è¦–çª—å®Œæˆé©—è­‰ï¼›ä¹‹å¾Œ Selenium å°±æ²¿ç”¨ sessionã€‚

RDP/é–è¢å¹•å½±éŸ¿ï¼šé€™å¥—æ˜¯ã€Œæœ‰é ­ã€Chromeã€‚è‹¥æ©Ÿå™¨æœƒé–è¢å¹•ã€RDP æœ€å°åŒ–ï¼Œå¯èƒ½å½±éŸ¿ç©©å®šæ€§ï¼›ç›¡é‡æ”¾åœ¨ä¸æœƒè‡ªå‹•é–è¢å¹•çš„æ©Ÿå™¨æˆ–èª¿æ•´é›»æºæ”¿ç­–ï¼ˆè‹¥å…¬å¸å…è¨±ï¼‰ã€‚

å…ƒç´ è®Šå‹•ï¼šæˆ‘ä½¿ç”¨è¼ƒç©©çš„ selectorï¼ˆ[role="textbox"][contenteditable="true"]ã€[data-tid="..."]ï¼‰ã€‚è‹¥ Teams UI æ›´æ–°ï¼Œå„ªå…ˆæ‰¾åŒæ¨£èªç¾©å±¬æ€§ï¼›å¿…è¦æ™‚ time.sleep(1-2) å¢å¼·ç©©å®šæ€§ã€‚

Chrome ç‰ˆæœ¬ç›¸å®¹ï¼šChromeDriver ä¸»ç‰ˆè™Ÿéœ€èˆ‡ Chrome ä¸€è‡´ã€‚

ä¸è¦åŒæ™‚æ‰“é–‹ç›¸åŒ Profile çš„ç¬¬äºŒå€‹ Chromeï¼šæˆ‘å€‘æ˜¯ã€Œé™„è‘—ã€åˆ°æ—¢æœ‰ Chromeï¼Œæ‰€ä»¥ä¸æœƒå¦é–‹ä¸€å€‹ï¼›ä¿æŒé€™å€‹æ¨¡å¼å³å¯é¿å…æª”æ¡ˆé–ç«¶çˆ­ã€‚

å¦‚æœä½ çµ¦æˆ‘ teamId / channelId æˆ– æ”¶ä»¶è€… email æ¸…å–®ï¼Œæˆ‘å¯ä»¥æŠŠä¸»ç¨‹å¼æ”¹æˆè®€ .env æˆ– JSON æ‰¹æ¬¡ç™¼é€ï¼Œé †ä¾¿åŠ ä¸Šé‡è©¦/æ—¥èªŒçš„ç°¡æ˜“æ¡†æ¶ï¼Œè®“ä½ ç›´æ¥ä¸Ÿé€²æ’ç¨‹å™¨è·‘ã€‚

---------------------------------------------------

æˆ‘å¹«ä½ åˆ†ã€Œç€è¦½å™¨ sessionã€å’Œã€ŒTeams ç™»å…¥å­˜æ´»æ™‚é–“ã€å…©å€‹å±¤é¢èªªæ˜ï¼š

1. ç€è¦½å™¨å±¤ (Chrome + Profile)

ä½ ç”¨ Selenium é™„è‘—åˆ° å·²ç™»å…¥çš„ Chrome profileï¼ˆæˆ–æ˜¯ remote-debugging-port é–‹çš„é‚£å€‹ Chromeï¼‰ï¼Œ
session å…¶å¯¦å°±æ˜¯ã€Œé€™å€‹ Chrome è¦–çª—è£¡çš„æ‰€æœ‰ç™»å…¥æ†‘è­‰ã€ã€‚

åªè¦ï¼š

ä¸è¦é—œæ‰ Chrome

ä¸è¦åˆªé™¤æˆ–è¦†è“‹ Profile
é‚£éº¼ session æœƒä¸€ç›´æ´»è‘—ï¼ŒSelenium é€£ä¸Šå®ƒæ™‚å°±èƒ½æ²¿ç”¨ã€‚

ä¸€æ—¦é‚£å€‹ Chrome è¦–çª—è¢«é—œé–‰ï¼ŒSelenium ä¹Ÿæ–·ç·šï¼›ä¸‹æ¬¡å†é–‹æœƒé‡æ–°å»ºç«‹ sessionï¼ˆä¸æœƒæ²¿ç”¨ä¹‹å‰çš„ debugger session idï¼‰ã€‚

2. Teams ç™»å…¥å±¤ (Token æ©Ÿåˆ¶)

Teams/Web å…¶å¯¦èƒŒå¾Œæ˜¯ Azure AD + Microsoft 365 ç™»å…¥ï¼š

Access Tokenï¼šå£½å‘½é€šå¸¸ 1 å°æ™‚å·¦å³ã€‚

Refresh Tokenï¼šå¸¸è¦‹ 24 å°æ™‚ï½90 å¤©ï¼ˆå–æ±ºæ–¼å…¬å¸ç§Ÿæˆ¶çš„ Sign-in frequency policyï¼Œå¯ç”± IT ç®¡ç†å“¡è¨­å®šï¼‰ã€‚

ä¾‹å¦‚å¾ˆå¤šå…¬å¸è¨­å®š 7 å¤©å¿…é ˆé‡æ–°é©—è­‰ä¸€æ¬¡ï¼Œæˆ– 12 å°æ™‚å°±è¦è¼¸å…¥ä¸€æ¬¡å¯†ç¢¼/MFAã€‚

Keep-aliveï¼šåªè¦ä½ æœ‰å®šæœŸæ´»å‹•ï¼ˆä¾‹å¦‚æ‰“é–‹é é¢ã€é€è¨Šæ¯ï¼‰ï¼ŒTeams Web æœƒç”¨ Refresh Token è‡ªå‹•æ›´æ–° Access Token â†’ è¡¨ç¾ç‚ºã€Œå¹¾ä¹ä¸€ç›´åœ¨ç·šã€ã€‚

æ‰€ä»¥ï¼š
ğŸ‘‰ åœ¨æ²’æœ‰é¡å¤–å…¬å¸æ”¿ç­–é™åˆ¶æ™‚ï¼Œã€Œä¸€å€‹å·²ç™»å…¥çš„ Teams Web sessionã€å¯ä»¥å­˜æ´»æ•¸é€±ç”šè‡³æ•¸æœˆï¼Œç›´åˆ°ï¼š

ä½ æ¸…é™¤äº† cookies / LocalStorage / IndexedDBï¼›

æˆ– IT è¨­å®šçš„ token lifetime åˆ°æœŸï¼ˆå¼·è¿«é‡æ–°ç™»å…¥ï¼‰ï¼›

æˆ–ä½ æ›å¯†ç¢¼ / IT å¼·åˆ¶ç™»å‡ºæ‰€æœ‰è£ç½®ã€‚

3. è·Ÿ Selenium å¯¦å‹™ä¸Šæ€éº¼æ­é…ï¼Ÿ

åŒä¸€å€‹ Chrome è¦–çª— + Profile å¯ä»¥æ’å¾ˆä¹…ï¼ˆåªè¦ä¸é—œï¼‰ã€‚

è‹¥è¦é•·æœŸæ’ç¨‹ï¼ˆæ¯å¤©è‡ªå‹•ç™¼è¨Šæ¯ï¼‰ï¼š

å»ºè­°å°ˆé–€æº–å‚™ä¸€å€‹ è‡ªå‹•åŒ–ç”¨çš„ Chrome profileï¼ˆé¿å…ä½ æ—¥å¸¸æ“ä½œæ‰“æ–·ï¼‰ã€‚

ç¬¬ä¸€æ¬¡ç™»å…¥ Web Teamsï¼Œå®Œæˆ MFAã€‚

ä¹‹å¾Œå°±å¯ä»¥ç”¨ Selenium å®šæœŸé™„è‘— â†’ ç™¼è¨Šæ¯ã€‚

ç›´åˆ° IT æ”¿ç­–è¦æ±‚é‡æ–°é©—è­‰ï¼Œä½ æ‰éœ€è¦æ‰‹å‹•å†ç™»å…¥ä¸€æ¬¡ã€‚

âœ… ç¸½çµ

Chrome debugger sessionï¼šæ´»åˆ°ä½ é—œæ‰é‚£å€‹ Chrome è¦–çª—ç‚ºæ­¢ã€‚

Teams ç™»å…¥ sessionï¼šå–æ±ºæ–¼å…¬å¸æ”¿ç­–ï¼Œé€šå¸¸æ•¸å¤©åˆ°æ•¸é€±ï¼›æ²’æœ‰æ¸… cookies çš„è©±å¯è‡ªå‹•çºŒæœŸã€‚

å¯¦å‹™ä¸Šåªè¦ä¸é—œæ‰ profileï¼Œé€šå¸¸èƒ½ç¶­æŒã€Œæ•¸é€±ä»¥ä¸Šã€çš„ç„¡äººè‡ªå‹•åŒ–ã€‚

è¦ä¸è¦æˆ‘å¹«ä½ è¨­è¨ˆä¸€å€‹ã€Œç›£æ¸¬ç™»å…¥æ˜¯å¦éæœŸã€çš„å°å‡½å¼ï¼Ÿ
ä¾‹å¦‚ï¼šå®šæœŸæª¢æŸ¥ç¶²é ä¸­æ˜¯å¦é‚„æœ‰ data-tid="messageItemBody" æˆ– ç™»å…¥é è¡¨å–®ï¼Œä¸€æ—¦åµæ¸¬åˆ°æ‰ç·šå°±è‡ªå‹•é€šçŸ¥ä½ ï¼ˆå¯„ email æˆ–å¯« logï¼‰ï¼Œé€™æ¨£ä½ å°±çŸ¥é“ä»€éº¼æ™‚å€™éœ€è¦äººå·¥é‡æ–°ç™»å…¥ã€‚




---------------------------------------

é€™é‚Šè¦åˆ†å…©å€‹å±¤æ¬¡ä¾†çœ‹ï¼š

1ï¸âƒ£ ã€Œå®Œå…¨éš±è— Chrome è¦–çª—ã€å¯ä¸å¯è¡Œï¼Ÿ

ä¸è¡Œï¼šå› ç‚ºä½ æ˜¯ç”¨ remote-debugging-port é™„è‘—åˆ°ä¸€å€‹ã€Œæ­£å¸¸çš„ Chrome Profileã€ï¼Œé€™ä¸€å®šæ˜¯ã€Œæœ‰é ­ã€ï¼ˆvisibleï¼‰æ¨¡å¼ã€‚

åŸå› ï¼š

å¦‚æœç”¨ --headlessï¼ŒChrome ä¸æœƒè¼‰å…¥ä½¿ç”¨è€… Profile çš„å®Œæ•´è³‡æ–™ï¼ˆcookiesã€LocalStorageã€IndexedDBï¼‰ï¼ŒTeams Web å¹¾ä¹ä¸€å®šæœƒåˆ¤å®šä½ æ²’ç™»å…¥ â†’ ç›´æ¥å°å»ç™»å…¥é ã€‚

æ‰€ä»¥è¦æ²¿ç”¨ã€Œå·²ç™»å…¥ç‹€æ…‹ã€ï¼Œå¿…é ˆå•Ÿå‹•ä¸€å€‹ã€Œæ­£å¸¸æœ‰é ­çš„ Chromeã€ã€‚

2ï¸âƒ£ é‚£èƒ½ä¸èƒ½ã€Œéš±è—ï¼æœ€å°åŒ–ï¼ä¸å¹²æ“¾ã€ï¼Ÿ

å¯ä»¥ï¼Œæœ‰å¹¾å€‹åšæ³•ï¼š

ğŸŸ¡ æ–¹æ³• Aï¼šæœ€å°åŒ–å•Ÿå‹•

å•Ÿå‹• Chrome æ™‚åŠ åƒæ•¸ï¼š

--start-minimized


â†’ é–‹æ©Ÿå°±ç¸®åˆ°å·¥ä½œåˆ—ï¼Œä¸å½±éŸ¿è¢å¹•ç•«é¢ã€‚

ğŸŸ¡ æ–¹æ³• Bï¼šæŒ‡å®šä½ç½® / å¤§å°åˆ°è¢å¹•å¤–

åŠ åƒæ•¸ï¼š

--window-position=-32000,-32000 --window-size=800,600


â†’ æŠŠè¦–çª—ä¸Ÿåˆ°è¢å¹•å¤–é‚Šç•Œï¼Œç­‰æ–¼ã€Œè‚‰çœ¼çœ‹ä¸åˆ°ã€ã€‚

ğŸŸ¡ æ–¹æ³• Cï¼šSelenium æ“æ§è¦–çª—

Selenium é€£ä¸Šå¾Œå¯ä»¥å‘¼å«ï¼š

driver.minimize_window()
# æˆ–è€…ç§»åˆ°è¢å¹•å¤–
driver.set_window_position(-2000, 0)

ğŸŸ¡ æ–¹æ³• Dï¼šæ”¾åœ¨è™›æ“¬æ¡Œé¢ / VM

Windows 10+ æ”¯æ´å¤šæ¡Œé¢ï¼Œå¯ä»¥æŠŠè‡ªå‹•åŒ–çš„ Chrome ä¸Ÿåˆ°å¦ä¸€å€‹æ¡Œé¢ï¼›

æˆ–è€…ç›´æ¥åœ¨ VM è£¡è·‘ï¼Œå¤–é¢ä¸æœƒçœ‹åˆ°ä»»ä½•è¦–çª—ã€‚

3ï¸âƒ£ âš ï¸ æ³¨æ„äº‹é …

ä¸å¯å…¨éš±è—ï¼šè‹¥ç”¨å·¥å…·æŠŠè¦–çª—å¼·åˆ¶ã€Œå®Œå…¨éš±è—ï¼ˆhide window handleï¼‰ã€æœ‰æ™‚å€™æœƒè®“ GPU / æ¸²æŸ“æš«åœï¼ŒTeams å¯èƒ½å¡ä½ â†’ Selenium æŠ“ä¸åˆ°å…ƒç´ ã€‚

æœ€å¥½æ˜¯ã€Œæœ€å°åŒ–ã€è€Œä¸æ˜¯ã€Œéš±å½¢ã€ï¼Œé€™æ¨£æ¸²æŸ“é‚„åœ¨é€²è¡Œï¼Œä½†ä¸å¹²æ“¾ä½ æ¡Œé¢ã€‚

æ’ç¨‹ç’°å¢ƒï¼šè‹¥ä½ æ‰“ç®—æ”¾åœ¨ Windows Task Scheduler è£¡è·‘ï¼Œè¨˜å¾—æŒ‡å®šã€ŒåŸ·è¡Œæ™‚ä¸é¡¯ç¤ºè¦–çª—ã€ï¼Œä½† Chrome ä»æœƒä»¥èƒŒæ™¯ç¨‹å¼æ–¹å¼å•Ÿå‹•ã€‚

âœ… ç¸½çµ

ä¸èƒ½ç”¨ headlessï¼ˆæœƒå¤±å»ç™»å…¥ç‹€æ…‹ï¼‰ã€‚

ä½†å¯ä»¥ç”¨ --start-minimized æˆ– --window-position è®“ Chromeã€Œæœ€å°åŒ– / ä¸Ÿåˆ°è¢å¹•å¤–ã€ï¼Œé”åˆ°å¹¾ä¹éš±è—çš„æ•ˆæœã€‚

æœ€ç©©å®šçš„æ–¹å¼æ˜¯ã€Œæœ€å°åŒ–ã€è€Œä¸æ˜¯å®Œå…¨éš±è—ã€‚

è¦ä¸è¦æˆ‘å¹«ä½ å¯«ä¸€å€‹ å°ˆé–€çš„å•Ÿå‹•åƒæ•¸ç¯„ä¾‹ï¼ˆåŒæ™‚åŒ…å« profileã€remote-debuggingã€æœ€å°åŒ–/éš±è—è¦–çª—ä½ç½®ï¼‰ï¼Œè®“ä½ ç›´æ¥è¤‡è£½å°±èƒ½ç”¨ä¾†å•Ÿå‹•é€™å€‹ã€Œéš±å½¢ Chrome for Teamsã€ï¼Ÿ



-----------------------------------------------------
Selenium æœ¬èº«æ²’æœ‰ã€Œåˆ‡æ› Windows è™›æ“¬æ¡Œé¢ã€çš„ APIï¼Œä½†å¯ä»¥ç”¨ç³»çµ±æ–¹æ³•æŠŠ Chrome è¦–çª—ç§»åˆ°å¦ä¸€å€‹æ¡Œé¢ï¼Œé€™æ¨£ä½ ä¸»æ¡Œé¢å°±ä¹¾æ·¨äº†ã€‚

ğŸ’¡ èƒŒæ™¯çŸ¥è­˜

Windows 10/11 çš„ã€Œè™›æ“¬æ¡Œé¢ã€(Virtual Desktops) æ˜¯ç³»çµ±å±¤åŠŸèƒ½ï¼Œ

Selenium åªèƒ½æ§åˆ¶ã€Œç€è¦½å™¨ DOMã€ï¼Œç„¡æ³•ç›´æ¥æ“ä½œæ¡Œé¢ã€‚

è¦æ¬è¦–çª—åˆ°å¦ä¸€æ¡Œé¢ï¼Œéœ€è¦é¡å¤–å‘¼å« Windows APIã€‚

ğŸ› ï¸ æ–¹æ³• 1ï¼šç”¨å¿«æ·éµè‡ªå‹•æ¬ç§» (æœ€ç°¡å–®)

åœ¨ Windows ä¸Šï¼š

Win + Ctrl + D â†’ å»ºç«‹æ–°æ¡Œé¢

Win + Ctrl + â†’/â† â†’ åˆ‡æ›æ¡Œé¢

Win + Tab â†’ å³éµè¦–çª— â†’ ç§»åˆ°æ¡Œé¢X â†’ æ‰‹å‹•æ“ä½œ

å¦‚æœåªè¦ã€Œä¸€æ¬¡è¨­å®šå¥½ï¼Œä¹‹å¾Œå›ºå®šæ”¾åœ¨æ¡Œé¢ 2ã€ï¼Œä½ å¯ä»¥ç”¨ AutoHotkeyï¼ˆAHKï¼‰æˆ– PowerShell åšè‡ªå‹•åŒ–ï¼Œå•Ÿå‹• Chrome å¾Œè‡ªå‹•æ¬èµ°ã€‚

ğŸ› ï¸ æ–¹æ³• 2ï¼šPython + pyvda (Virtual Desktop API)

æœ‰ä¸€å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶ pyvdaï¼Œèƒ½ç›´æ¥æŠŠæŒ‡å®šè¦–çª—ä¸Ÿåˆ°ç‰¹å®šè™›æ“¬æ¡Œé¢ã€‚
ï¼ˆæ³¨æ„ï¼šéœ€è¦èƒ½å®‰è£ pip å¥—ä»¶ï¼‰

å®‰è£ï¼š

pip install pyvda pywin32


ç¯„ä¾‹ï¼š

import win32gui
import pyvda

# æ‰¾åˆ° Chrome è¦–çª— (ç”¨æ¨™é¡Œé—œéµå­—)
def get_chrome_hwnd():
    hwnds = []
    def callback(hwnd, _):
        if win32gui.IsWindowVisible(hwnd):
            title = win32gui.GetWindowText(hwnd)
            if "Google Chrome" in title:
                hwnds.append(hwnd)
    win32gui.EnumWindows(callback, None)
    return hwnds[0] if hwnds else None

chrome_hwnd = get_chrome_hwnd()
if chrome_hwnd:
    desktop2 = pyvda.VirtualDesktop(2)   # ç¬¬äºŒå€‹æ¡Œé¢
    pyvda.MoveWindowToDesktop(chrome_hwnd, desktop2)
    print("å·²ç§»å‹•åˆ°æ¡Œé¢ 2")
else:
    print("æ‰¾ä¸åˆ° Chrome è¦–çª—")

ğŸ› ï¸ æ–¹æ³• 3ï¼šç”¨ VM / RDP ä»£æ›¿

å¦‚æœå…¬å¸å…è¨±ï¼Œä¹¾è„†åœ¨ä¸€å° VMï¼ˆæˆ–å¦ä¸€å€‹ä½¿ç”¨è€…å¸³è™Ÿï¼‰è£¡è·‘è‡ªå‹•åŒ–ï¼Œä¸»æ¡Œé¢å°±ä¸æœƒçœ‹åˆ°ä»»ä½•è¦–çª—ã€‚

âš ï¸ æ³¨æ„äº‹é …

pyvda åªèƒ½åœ¨ Windows 10+ ç”¨ï¼Œä¸”éœ€è¦æœ‰è™›æ“¬æ¡Œé¢åŠŸèƒ½é–‹å•Ÿã€‚

å¦‚æœä½ çš„ç’°å¢ƒ ä¸èƒ½å®‰è£ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼ˆä¾‹å¦‚å…¬å¸ GPO é™åˆ¶ï¼‰ï¼Œé‚£å°±åªèƒ½ç”¨ å¿«æ·éµ/æ‰‹å‹•ç§»å‹•ï¼Œæˆ–è€…è·‘åœ¨ VMã€‚

æŠŠ Chrome ä¸Ÿåˆ°å¦ä¸€æ¡Œé¢å¾Œï¼Œå®ƒä¾ç„¶åœ¨è·‘ã€Selenium ç…§æ¨£èƒ½æ§åˆ¶ï¼›åªæ˜¯ä½ ä¸»æ¡Œé¢ä¸æœƒçœ‹åˆ°ã€‚

âœ… ç¸½çµ

ç°¡å–®æ–¹æ¡ˆï¼šæ‰‹å‹• Win+Tabï¼ŒæŠŠ Chrome ä¸Ÿåˆ°æ¡Œé¢ 2ã€‚

ç¨‹å¼åŒ–æ–¹æ¡ˆï¼šç”¨ pyvda æ­é… win32gui è‡ªå‹•æ¬ã€‚

éš”é›¢æ–¹æ¡ˆï¼šç›´æ¥ç”¨ VM / RDP è·‘ã€‚

è¦ä¸è¦æˆ‘å¹«ä½ å¯«ä¸€å€‹ å®Œæ•´çš„å•Ÿå‹•è…³æœ¬ï¼ˆåŒæ™‚å•Ÿå‹• Chrome + remote-debugging + è‡ªå‹•æ¬åˆ°æ¡Œé¢ 2ï¼‰ï¼Œé€™æ¨£ä½ ä¸€éµå°±èƒ½å¾—åˆ°ä¸€å€‹ã€Œéš±è—åœ¨æ¡Œé¢ 2ã€çš„ Teams è‡ªå‹•åŒ–ç€è¦½å™¨ï¼Ÿ

------------------------------------

å¯ä»¥çš„ï¼ä½ å¯ä»¥åŒæ™‚è·‘ã€Œå…©éš»ã€Seleniumã€‚åšæ³•èˆ‡æ³¨æ„äº‹é …å¦‚ä¸‹ï¼š

æ ¸å¿ƒåŸå‰‡

æ¯ä¸€éš» WebDriver = ä¸€å€‹ç¨ç«‹ç€è¦½å™¨æœƒè©±
ä½ å¯ä»¥åœ¨åŒä¸€æ”¯ç¨‹å¼è£¡å»ºç«‹å…©å€‹ webdriver.Chrome() ç‰©ä»¶ï¼Œæˆ–åˆ†æˆå…©å€‹è¡Œç¨‹ï¼ˆå»ºè­°ï¼‰ã€‚

é¿å…å…±ç”¨åŒä¸€å€‹ profile

çµ¦ Teams ç”¨çš„ä¸€éš»ï¼šé™„è‘—åˆ°å·²ç™»å…¥çš„ Chromeï¼ˆdebuggerAddressï¼‰ã€‚

çµ¦ å…¶ä»–ä»»å‹™çš„ä¸€éš»ï¼šé–‹ æ–°çš„ Chrome å¯¦ä¾‹ï¼ˆä¸åŒçš„ user-data-dirï¼Œæˆ–ä¹¾è„†ä¸æŒ‡å®šï¼›ä¹Ÿå¯ä»¥ headlessï¼‰ã€‚

ä¸è¦åŒæ™‚ç”¨å…©å€‹å¯¦ä¾‹å ç”¨åŒä¸€å€‹ user-data-dir
åŒä¸€å€‹ profile åŒæ™‚é–“åªèƒ½è¢«ä¸€å€‹ Chrome å¯¦ä¾‹é–‹å•Ÿï¼Œå¦å‰‡æœƒé–æª”æˆ–ææ¯€ã€‚

ä¸è¦å…©éš»åŒæ™‚é™„è‘—åŒä¸€å€‹ remote-debugging-port
é›–ç„¶ CDP æŠ€è¡“ä¸Šå¯å¤šé€£ç·šï¼Œä½†å¯¦å‹™ä¸Šå®¹æ˜“äº’è¸©ï¼ˆäº‹ä»¶æµã€ç„¦é»ã€tab åˆ‡æ›ï¼‰ï¼Œä¸å»ºè­°ã€‚

å¯¦ä½œç¯„ä¾‹ï¼šå…©éš»åŒæ™‚è·‘

Aï¼šé™„è‘—åˆ°ä½ å·²ç™»å…¥ Teams çš„ Chromeï¼ˆå…ˆç”¨ --remote-debugging-port=9222 èµ·å¥½ï¼‰

Bï¼šç¨ç«‹ä¸€å€‹ä¹¾æ·¨çš„è‡ªå‹•åŒ–ç€è¦½å™¨ï¼ˆå¯ headlessï¼‰

import time
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

# ===== Aï¼šé™„è‘—åˆ°å·²ç™»å…¥çš„ Chromeï¼ˆTeamsï¼‰=====
def attach_teams_driver():
    opts = Options()
    opts.add_experimental_option("debuggerAddress", "127.0.0.1:9222")
    opts.add_experimental_option("excludeSwitches", ["enable-automation"])
    opts.add_experimental_option("useAutomationExtension", False)
    return webdriver.Chrome(options=opts)

# ===== Bï¼šé–‹æ–°çš„ Chromeï¼ˆåšå…¶ä»–äº‹ï¼‰=====
def new_worker_driver(headless=True, user_data_dir=None):
    opts = Options()
    if headless:
        opts.add_argument("--headless=new")
        opts.add_argument("--disable-gpu")
    if user_data_dir:
        opts.add_argument(f"--user-data-dir={user_data_dir}")  # æ³¨æ„ï¼šä¸èƒ½èˆ‡ Teams é‚£éš»ç›¸åŒ
    return webdriver.Chrome(options=opts)

# å»ºç«‹å…©å€‹ WebDriver ç‰©ä»¶
teams = attach_teams_driver()
worker = new_worker_driver(headless=True)  # æˆ– headless=False è¦–éœ€æ±‚

# å„åšå„çš„
teams.get("https://teams.microsoft.com/?clientType=web")   # ç”¨ä½ çš„ç™¼è¨Šæ¯æµç¨‹å³å¯
worker.get("https://example.com/")                         # å¦ä¸€éš»åšåˆ¥çš„å·¥ä½œ

time.sleep(2)

# çµæŸï¼ˆteams é‚£éš»åªæ˜¯æ–·é–‹æ§åˆ¶ï¼Œä¸æœƒé—œæ‰åŸæœ¬ Chrome è¦–çª—ï¼‰
worker.quit()
# teams.quit()  # å¦‚æœä½ æƒ³è§£é™¤é™„è‘—ï¼Œå¯å‘¼å«ï¼›åŸæœ¬é‚£å€‹å·²ç™»å…¥çš„ Chrome ä»æœƒç•™è‘—

ä½µç™¼å»ºè­°

åŒä¸€ç¨‹å¼åŒæ™‚æ“æ§ï¼šç”¨å…©å€‹ thread å¯ä»¥ï¼Œä½† Selenium å‘¼å«æ˜¯é˜»å¡çš„ï¼›
æƒ³è¦æ›´ç©©ï¼Œæ”¹ç”¨ multiprocessing / å…©æ”¯ç¨ç«‹è…³æœ¬ï¼Œäº’ä¸å½±éŸ¿ã€‚

è³‡æºï¼šå…©å€‹ç€è¦½å™¨å¾ˆåƒ RAM/CPUï¼Œç›¡é‡è®“ã€Œå…¶ä»–ä»»å‹™ã€é‚£éš»è·‘ headlessã€‚

è¦–çª—å¹²æ“¾ï¼šTeams é‚£éš»å¯ä»¥æœ€å°åŒ–ï¼ä¸Ÿåˆ°å¦ä¸€å€‹æ¡Œé¢ï¼›å¦ä¸€éš» headless å°±ä¸æœƒå‡ºç¾è¦–çª—ã€‚

å¸¸è¦‹å‘ä½

port è¡çªï¼šåªæœ‰ã€Œé™„è‘—é‚£éš»ã€éœ€è¦ debuggerAddressï¼›å¦ä¸€éš»ä¸è¦è¨­å®šï¼ˆæˆ–è‹¥ä½ çœŸçš„è¦ç¬¬äºŒå€‹å¯é™„è‘— Chromeï¼Œè«‹ç”¨ä¸åŒçš„ --remote-debugging-portï¼Œä¾‹å¦‚ 9223ï¼Œä¸”ä¸åŒ user-data-dirï¼‰ã€‚

åŒ profile ç«¶çˆ­ï¼šä¸è¦è®“ç¬¬äºŒéš»ç”¨åˆ° Teams çš„åŒä¸€å€‹ user-data-dirã€‚

ç„¦é»å½±éŸ¿ï¼šè‹¥å…©éš»éƒ½ã€Œæœ‰é ­ã€ï¼Œä¸”éƒ½åœ¨åŒä¸€å€‹æ¡Œé¢ä¸Šæ“ä½œåŒä¸€å€‹è¢å¹•ï¼Œå¯èƒ½äº’æ¶ç„¦é»ï¼›æŠŠ Teams é‚£éš»æœ€å°åŒ–æˆ–ç§»åˆ°è™›æ“¬æ¡Œé¢ã€‚

ç¸½çµ

å¯ä»¥åŒæ™‚å•Ÿç”¨å…©éš» Seleniumã€‚

è®“ Teams å°ˆç”¨çš„ä¸€éš»é™„è‘—åˆ°ä½ å·²ç™»å…¥çš„ Chromeï¼›

å¦ä¸€éš»ç”¨ æ–°çš„ç¨ç«‹å¯¦ä¾‹ï¼ˆæœ€å¥½ headlessï¼‰ åšå…¶ä»–äº‹ï¼›

åˆ‡è¨˜ ä¸åŒ profile / ä¸åŒ debugging port / ç›¡é‡åˆ†æ¡Œé¢æˆ– headlessï¼Œå°±èƒ½ç©©å®šå…±å­˜ã€‚

å¦‚æœä½ è¦ï¼Œæˆ‘å¯ä»¥æŠŠé€™å¥—æ‹†æˆå…©å€‹å¯æ’ç¨‹çš„è…³æœ¬ç¯„æœ¬ï¼ˆå« .bat å•Ÿå‹•ã€æ—¥èªŒèˆ‡éŒ¯èª¤é‡è©¦ï¼‰ï¼Œè®“å®ƒå€‘äº’ä¸å¹²æ“¾åœ°é•·æœŸè·‘ã€‚



å¯ä»¥ï¼è¦åŒæ™‚ã€Œå…©éš»éƒ½é™„è‘—åˆ° Chromeã€ï¼Œé‡é»æ˜¯ï¼šå•Ÿå…©å€‹ä¸åŒçš„ Chrome å¯¦ä¾‹ï¼Œå„è‡ªç”¨ä¸åŒçš„ remoteâ€‘debuggingâ€‘portï¼Œè€Œä¸”ä¸åŒçš„ userâ€‘dataâ€‘dir / profileï¼ˆåŒä¸€å€‹ profile ä¸èƒ½åŒæ™‚é–‹å…©æ¬¡ï¼‰ã€‚

ä¸‹é¢çµ¦ä½ å®Œæ•´å¯ç”¨çš„åšæ³•ï¼ˆWindowsï¼‰ï¼š

â‘  å…ˆå•Ÿå…©å€‹ Chromeï¼ˆå„è‡ªçš„é€£æ¥åŸ èˆ‡å€‹äººè³‡æ–™å¤¾ï¼‰
A. Teams ç”¨ï¼ˆæ²¿ç”¨ä½ å¹³å¸¸å·²ç™»å…¥çš„é‚£å€‹ profileï¼‰

å»ºç«‹ start_teams_chrome.batï¼š

@echo off
set CHROME="C:\Program Files\Google\Chrome\Application\chrome.exe"
set USERDATA=C:\Users\<ä½ çš„å¸³è™Ÿ>\AppData\Local\Google\Chrome\User Data
set PROFILE=Default

%CHROME% ^
  --remote-debugging-port=9222 ^
  --user-data-dir="%USERDATA%" ^
  --profile-directory="%PROFILE%" ^
  --start-minimized ^
  --app="https://teams.microsoft.com/?clientType=web"


æŠŠ <ä½ çš„å¸³è™Ÿ> / Default æ›æˆä½ å¯¦éš›çš„ã€‚ç¬¬ä¸€æ¬¡è«‹æ‰‹å‹•åœ¨é€™å€‹è¦–çª—å®Œæˆç™»å…¥ï¼ˆå« MFAï¼‰ã€‚

B. å¦ä¸€éš»å·¥ä½œç”¨ï¼ˆç¨ç«‹ profileï¼‰

å»ºç«‹ä¸€å€‹è‡ªå‹•åŒ–å°ˆç”¨ profileï¼ˆé¿å…é–æª”ï¼‰ï¼Œä¾‹å¦‚ User Data\Auto1ã€‚
start_worker_chrome.batï¼š

@echo off
set CHROME="C:\Program Files\Google\Chrome\Application\chrome.exe"
set USERDATA=C:\Users\<ä½ çš„å¸³è™Ÿ>\AppData\Local\Google\Chrome\User Data
set PROFILE=Auto1

%CHROME% ^
  --remote-debugging-port=9223 ^
  --user-data-dir="%USERDATA%" ^
  --profile-directory="%PROFILE%" ^
  --start-minimized


å…©å€‹æ‰¹æ¬¡æª”éƒ½å¯ä»¥æ”¾åˆ°å·¥ä½œæ’ç¨‹å™¨é–‹æ©Ÿå•Ÿå‹•ï¼›port å¿…é ˆä¸åŒï¼ˆ9222 / 9223ï¼‰ï¼Œprofile ä¹Ÿä¸åŒã€‚

â‘¡ Selenium åŒæ™‚é™„è‘—å…©éš»ï¼ˆå„é€£åˆ°ä¸åŒçš„åŸ ï¼‰
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

def attach(debugger_addr: str) -> webdriver.Chrome:
    opts = Options()
    opts.add_experimental_option("debuggerAddress", debugger_addr)
    # å¯é¸ï¼šç•¥æ¸›å°‘è‡ªå‹•åŒ–æ©«å¹…
    opts.add_experimental_option("excludeSwitches", ["enable-automation"])
    opts.add_experimental_option("useAutomationExtension", False)
    return webdriver.Chrome(options=opts)

# Aï¼šTeamsï¼ˆé€£åˆ° 9222ï¼‰
teams = attach("127.0.0.1:9222")

# Bï¼šå¦ä¸€éš»å·¥ä½œç”¨ï¼ˆé€£åˆ° 9223ï¼‰
worker = attach("127.0.0.1:9223")

# === å„åšå„çš„äº‹ ===
teams.get("https://teams.microsoft.com/?clientType=web")  # é€™éš»ç…§ä½ çš„ç™¼è¨Šæµç¨‹å³å¯
worker.get("https://example.com/")                        # å¦ä¸€éš»åšå…¶ä»–è‡ªå‹•åŒ–ä»»å‹™

# â€¦å®Œæˆå¾Œï¼ˆæ³¨æ„ï¼šquit() åªæœƒæ–·é–‹æ§åˆ¶ï¼Œä¸æœƒé—œæ‰åŸæœ¬çš„ Chrome è¦–çª—ï¼‰
# worker.quit()
# teams.quit()

ç©©å®šåº¦ & å°æé†’

ä¸è¦å…±ç”¨åŒä¸€å€‹ user-data-dir/profileï¼šåŒä¸€ profile åŒæ™‚åªæœ‰ä¸€å€‹ Chrome èƒ½ç”¨ï¼›ç¬¬äºŒå€‹æœƒé–æª”æˆ–ææ¯€ã€‚

æ¯éš»ä¸€å€‹åŸ ï¼šä¾‹å¦‚ 9222 èˆ‡ 9223ï¼›è‹¥è¦æ›´å¤šå¯¦ä¾‹ï¼Œä¾åº 9224ã€9225â€¦ã€‚

æœ€å°åŒ–/ä¸å¹²æ“¾ï¼šæ‰¹æ¬¡æª”è£¡åŠ äº† --start-minimizedï¼›ä¹Ÿå¯åœ¨é™„è‘—å¾Œ driver.minimize_window() æˆ–æŠŠè¦–çª—ç§»åˆ°å…¶ä»–æ¡Œé¢ï¼ˆä½ å‰é¢æé pyvda æ–¹æ¡ˆï¼‰ã€‚

RDP/é–è¢å¹•ï¼šé€™æ˜¯ã€Œæœ‰é ­ã€Chromeï¼Œæ¥µç«¯æƒ…æ³å¯èƒ½å—å½±éŸ¿ï¼›å»ºè­°æ”¾åœ¨ä¸æœƒè‡ªå‹•é–è¢å¹•çš„æ©Ÿå™¨æˆ–å°ˆç”¨ VMã€‚

ç‰ˆæœ¬å°æ‡‰ï¼šChromeDriver ä¸»ç‰ˆè™Ÿè¦èˆ‡ Chrome ä¸€è‡´ã€‚

Teams å¼·åˆ¶ Webï¼šé€£ Teams æ™‚è¨˜å¾— ?clientType=webï¼Œé¿å…è¢«å¸¶å»æ¡Œé¢ Appã€‚

æ—¥èªŒèˆ‡æ•…éšœå›å¾©ï¼šå»ºè­°åœ¨ Python ç«¯åŠ  try/retry èˆ‡ç°¡å–®å¥åº·æª¢æŸ¥ï¼ˆä¾‹å¦‚æª¢æŸ¥æ˜¯å¦é‚„åœ¨èŠå¤©é ã€æœ‰ç„¡è¼¸å…¥æ¡†ï¼‰ã€‚

é€™æ¨£ä½ å°±èƒ½ã€Œå…©éš»éƒ½é™„è‘—åˆ°ä¸åŒçš„ Chromeã€ï¼Œä¸€éš»å°ˆé–€ç®¡ Teamsï¼Œå¦ä¸€éš»åŒæ™‚åšå…¶ä»–ä»»å‹™ï¼Œäº’ä¸å¹²æ“¾ã€ç©©å®šé‹è¡Œã€‚éœ€è¦æˆ‘å¹«ä½ æŠŠä¸Šé¢ Python ç¨‹å¼è£œä¸Šè¨Šæ¯è¼¸å…¥/é€å‡ºå‡½å¼èˆ‡å¥åº·æª¢æŸ¥éª¨æ¶å—ï¼Ÿ


---------------------------------------------------






å¦‚ä½•æª¢æŸ¥ ChromeDriver ä¸»ç‰ˆè™Ÿè¦èˆ‡ Chrome ä¸€è‡´ , è‹¥ä¸ç›¸åŒè‡ªå‹•åˆ°pypl ä¸‹è¼‰
ChatGPT èªªï¼š
å·²æ€è€ƒ 21s

å¯ä»¥ï¼ä¸‹é¢çµ¦ä½ ä¸€å€‹ä¸€éµæª¢æŸ¥ & è‡ªå‹•å®‰è£çš„ Python è…³æœ¬ï¼Œæœƒï¼š

è®€å–æœ¬æ©Ÿ Chrome ç‰ˆæœ¬ï¼ˆWindows/macOS/Linux çš†å¯ï¼‰

æª¢æŸ¥ç›®å‰ chromedriver ä¸»ç‰ˆè™Ÿæ˜¯å¦ä¸€è‡´

è‹¥ä¸ä¸€è‡´æˆ–æ²’å®‰è£ï¼Œå°±åˆ° PyPI å®‰è£å°æ‡‰ç‰ˆ chromedriver-binary==<ç²¾ç¢ºç‰ˆæœ¬>

é©—è­‰å®‰è£æˆåŠŸï¼Œä¸¦ç¤ºç¯„å¦‚ä½•åœ¨ Selenium å…§ä½¿ç”¨

èªªæ˜ï¼šæˆ‘å€‘ç›´æ¥å¾ PyPI çš„ chromedriver-binary å–å°æ‡‰ç‰ˆæœ¬ï¼ˆä¸æ˜¯å» Google Storageï¼‰ï¼Œä¸¦è‡ªå‹•æŒ‘é¸ã€Œèˆ‡ä½  Chrome ä¸»ç‰ˆè™Ÿä¸€è‡´ã€çš„æœ€æ–°å­ç‰ˆã€‚



-----------------------------

è…³æœ¬ï¼šauto_chromedriver_pypi.py
import json, os, re, subprocess, sys, platform, shutil
from urllib.request import urlopen

PYPI_PKG = "chromedriver-binary"

def run(cmd, check=False):
    return subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, check=check)

def chrome_version():
    """
    å–å¾—æœ¬æ©Ÿ Chrome ç‰ˆæœ¬å­—ä¸²ï¼Œä¾‹å¦‚ '128.0.6613.120'
    ç›¡é‡ä»¥ chrome.exe/Google Chrome --version ç‚ºä¸»ï¼›Windows ä¹Ÿå˜—è©¦ç™»éŒ„æ©Ÿç¢¼ã€‚
    """
    sysname = platform.system()
    candidates = []

    if sysname == "Windows":
        # 1) ç›´æ¥å‘¼å« chrome.exe --versionï¼ˆå¸¸è¦‹å®‰è£è·¯å¾‘ï¼‰
        candidates = [
            r"C:\Program Files\Google\Chrome\Application\chrome.exe",
            r"C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
        ]
        for p in candidates:
            if os.path.exists(p):
                out = run([p, "--version"]).stdout.strip()
                m = re.search(r"(\d+\.\d+\.\d+\.\d+)", out)
                if m:
                    return m.group(1)
        # 2) é€€è€Œæ±‚å…¶æ¬¡ï¼šç™»éŒ„æ©Ÿç¢¼ï¼ˆBLBeaconï¼‰
        try:
            out = run(["reg", "query", r"HKLM\SOFTWARE\Google\Chrome\BLBeacon", "/v", "version"]).stdout
            m = re.search(r"REG_SZ\s+(\d+\.\d+\.\d+\.\d+)", out)
            if m:
                return m.group(1)
        except Exception:
            pass

    elif sysname == "Darwin":
        # macOS
        candidates = [
            "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",
            os.path.expanduser("~/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"),
        ]
        for p in candidates:
            if os.path.exists(p):
                out = run([p, "--version"]).stdout.strip()
                m = re.search(r"(\d+\.\d+\.\d+\.\d+)", out)
                if m:
                    return m.group(1)

    else:
        # Linux
        for binname in ["google-chrome", "google-chrome-stable", "chromium-browser", "chromium"]:
            path = shutil.which(binname)
            if path:
                out = run([path, "--version"]).stdout.strip()
                m = re.search(r"(\d+\.\d+\.\d+\.\d+)", out)
                if m:
                    return m.group(1)

    raise RuntimeError("æ‰¾ä¸åˆ°æœ¬æ©Ÿ Chrome ç‰ˆæœ¬ï¼Œè«‹ç¢ºèªå·²å®‰è£ä¸”å¯åŸ·è¡Œã€‚")

def chromedriver_version():
    """
    å–å¾—ç›®å‰ chromedriver ä¸»ç¨‹å¼ç‰ˆæœ¬ï¼ˆè‹¥ä¸å­˜åœ¨å‰‡å›å‚³ Noneï¼‰
    """
    path = shutil.which("chromedriver")
    if not path:
        return None
    out = run([path, "--version"]).stdout
    m = re.search(r"ChromeDriver\s+(\d+\.\d+\.\d+\.\d+)", out)
    return m.group(1) if m else None

def pypi_latest_for_major(major: str):
    """
    å¾ PyPI å–å¾— chromedriver-binary çš„æ‰€æœ‰ç‰ˆæœ¬ï¼ŒæŒ‘å‡ºæŒ‡å®šä¸»ç‰ˆè™Ÿçš„æœ€æ–°ç‰ˆæœ¬å­—ä¸²ã€‚
    ä¾‹å¦‚ major='128' -> '128.0.6613.119.0'
    """
    url = f"https://pypi.org/pypi/{PYPI_PKG}/json"
    with urlopen(url, timeout=15) as resp:
        data = json.load(resp)
    # ç‰ˆæœ¬æ ¼å¼å¸¸è¦‹åƒ '128.0.6613.119.0'ï¼ˆæœ€å¾Œä¸€æ®µæ˜¯åŒ…è£ç‰ˆæ¬¡ï¼‰
    all_versions = list(data["releases"].keys())
    cand = [v for v in all_versions if v.split(".")[0] == str(major)]
    if not cand:
        raise RuntimeError(f"PyPI ä¸Šæ‰¾ä¸åˆ° {PYPI_PKG} çš„ä¸»ç‰ˆ {major} å°æ‡‰ç‰ˆæœ¬ã€‚")
    # ä½¿ç”¨èªæ„æ’åºï¼šä¾æ¯æ®µæ•´æ•¸å¤§å°æ’åº
    def keyf(v):
        return tuple(int(x) for x in re.findall(r"\d+", v))
    cand.sort(key=keyf, reverse=True)
    return cand[0]

def ensure_matching_chromedriver():
    chrome_ver = chrome_version()
    chrome_major = chrome_ver.split(".", 1)[0]
    print(f"[i] æœ¬æ©Ÿ Chrome ç‰ˆæœ¬ï¼š{chrome_ver}ï¼ˆä¸»ç‰ˆ {chrome_major}ï¼‰")

    cdrv_ver = chromedriver_version()
    if cdrv_ver:
        cdrv_major = cdrv_ver.split(".", 1)[0]
        print(f"[i] ç›®å‰ chromedriver ç‰ˆæœ¬ï¼š{cdrv_ver}ï¼ˆä¸»ç‰ˆ {cdrv_major}ï¼‰")
    else:
        print("[i] ç³»çµ±æ‰¾ä¸åˆ° chromedriverï¼ˆå°‡å®‰è£å°æ‡‰ç‰ˆæœ¬ï¼‰")

    need_install = (cdrv_ver is None) or (cdrv_major != chrome_major)

    if not need_install:
        print("[âœ“] ä¸»ç‰ˆä¸€è‡´ï¼Œç„¡éœ€å®‰è£ã€‚")
        return

    target = pypi_latest_for_major(chrome_major)
    print(f"[â†’] å°‡å®‰è£ PyPI {PYPI_PKG} ç‰ˆæœ¬ï¼š{target}ï¼ˆå°æ‡‰ Chrome ä¸»ç‰ˆ {chrome_major}ï¼‰")

    # ç”¨ç•¶å‰ Python çš„ pip å®‰è£
    cmd = [sys.executable, "-m", "pip", "install", "-U", f"{PYPI_PKG}=={target}"]
    print("[â€¦] åŸ·è¡Œï¼š", " ".join(cmd))
    res = run(cmd)
    print(res.stdout)

    # åŒ¯å…¥ chromedriver_binary æœƒæŠŠå°æ‡‰çš„ driver æ”¾åˆ° PATHï¼ˆé€é sitecustomizeï¼‰
    try:
        import chromedriver_binary  # noqa: F401
    except Exception as e:
        print("[!] åŒ¯å…¥ chromedriver_binary å¤±æ•—ï¼š", e)

    # å†æ¬¡é©—è­‰
    new_ver = chromedriver_version()
    if not new_ver:
        raise RuntimeError("å®‰è£å¾Œä»æ‰¾ä¸åˆ° chromedriverï¼Œè«‹æª¢æŸ¥ pip/ç’°å¢ƒè®Šæ•¸ã€‚")
    new_major = new_ver.split(".", 1)[0]
    if new_major != chrome_major:
        raise RuntimeError(f"å®‰è£å¾Œä¸»ç‰ˆä»ä¸ä¸€è‡´ï¼šChrome {chrome_major} vs chromedriver {new_major}")
    print(f"[âœ“] å®‰è£å®Œæˆï¼Œchromedriver ç‰ˆæœ¬ï¼š{new_ver}ï¼ˆä¸»ç‰ˆä¸€è‡´ï¼‰")

if __name__ == "__main__":
    ensure_matching_chromedriver()
    print("\nä½¿ç”¨ç¯„ä¾‹ï¼ˆSeleniumï¼‰ï¼š")
    print(r"""
from selenium import webdriver
from selenium.webdriver.chrome.service import Service

# chromedriver-binary å·²æŠŠæ­£ç¢ºç‰ˆæœ¬åŠ å…¥ PATHï¼Œç›´æ¥å»ºå°±è¡Œ
driver = webdriver.Chrome()            # æˆ– webdriver.Chrome(service=Service())
driver.get("https://www.example.com")
print(driver.title)
driver.quit()
""")

ä½¿ç”¨æ–¹å¼

å„²å­˜æˆ auto_chromedriver_pypi.py

åŸ·è¡Œï¼š

python auto_chromedriver_pypi.py


çœ‹åˆ° [âœ“] å®‰è£å®Œæˆ å¾Œï¼Œä½ å°±å¯ä»¥ç›´æ¥åœ¨ç¨‹å¼è£¡ webdriver.Chrome()ã€‚


----------------------------------------





å°æé†’ / å¸¸è¦‹æƒ…æ³

æ¬Šé™/å°ç¶²ï¼šè‹¥å…¬å¸ç¶²è·¯ç„¡æ³•é€£åˆ° PyPIï¼Œé€™æ–¹æ³•æœƒå¤±æ•—ï¼ˆå¯æ”¹å…§éƒ¨é¡åƒï¼‰ã€‚

å¤šå€‹ Python/è™›æ“¬ç’°å¢ƒï¼šè«‹ç”¨ä½ å¯¦éš›è·‘ Selenium çš„é‚£å€‹ Python ä¾†åŸ·è¡Œè…³æœ¬ï¼Œç¢ºä¿è£åˆ°åŒä¸€ç’°å¢ƒã€‚

Edge/Chromium è®Šé«”ï¼šå¦‚æœä½ ç”¨çš„æ˜¯ Edgeï¼Œè«‹æ”¹ç”¨å°æ‡‰å¥—ä»¶ msedge-selenium-tools æˆ– EdgeDriverï¼›é€™å€‹è…³æœ¬åƒ…è™•ç† Chrome/Chromedriverã€‚

Selenium Managerï¼ˆæ›¿ä»£åšæ³•ï¼‰ï¼šè‹¥ä½ å‡åˆ° selenium>=4.10ï¼Œä¹Ÿå¯ä»¥ä¸å®‰è£ä»»ä½• driverï¼Œç›´æ¥ webdriver.Chrome()ï¼ŒSelenium æœƒè‡ªå‹•æŠ“ç›¸å®¹ driverï¼ˆé PyPI ä¾†æºï¼‰ã€‚ä½ æŒ‡å®šã€Œä¸€å®šè¦ PyPIã€ï¼Œå°±ç”¨æœ¬è…³æœ¬ã€‚


























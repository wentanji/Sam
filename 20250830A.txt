# Teams è‡ªå‹•ç›£è½ï¼‹è‡ªå‹•å›è¦†ï¼šè©³ç´°æµç¨‹åœ–èˆ‡è¨»è§£

> çµ„æˆï¼š`watcher.py`ï¼ˆç›£è½ç«¯ï¼‰ï¼‹ `sender_server.py`ï¼ˆè‡ªå‹•å›è¦†ç«¯ï¼‰ï¼‹ `config.yaml`ï¼ˆè¨­å®šï¼‰ï¼‹ æ—¥èªŒ & å•Ÿå‹•/æ’ç¨‹è…³æœ¬ã€‚

---

## 1) ç³»çµ±ç¸½è¦½ï¼ˆå…ƒä»¶äº’å‹•åœ–ï¼‰

```mermaid
flowchart LR
  subgraph CH[Chromeï¼ˆå·²ç™»å…¥ Teamsï¼›remoteâ€‘debugging 9992ï¼‰]
    TW1[Teams Web åˆ†é  #1]
    TW2[Teams Web åˆ†é  #N]
  end

  CFG[[config.yaml]]
  W[watcher.py\n(å¤šåˆ†é ç›£è½)]
  JS[TeamsWatch\nMutationObserver\n(æ³¨å…¥ JS)]
  S[sender_server.py\n(HTTP ä¼ºæœå™¨ / è¦å‰‡å¼•æ“)]
  L1[(logs/watcher_events.ndjson)]
  L2[(logs/sender_actions.ndjson)]
  HB[[/health /stats å¿ƒè·³&çµ±è¨ˆ]]
  TS[[Windows Task Scheduler\n task_*.xml]]
  BAT[[start_watcher.bat / start_sender.bat]]

  CFG --> W
  CFG --> S
  W -->|é–‹åˆ†é /å°å‘ Deep Link| CH
  W -.æ³¨å…¥.-> JS
  JS -- äº‹ä»¶(batch) --> W
  W -->|HTTP POST /event| S
  W --> L1
  S -->|é–å®š/é–‹åˆ†é | CH
  S -->|é€å‡ºæ–‡å­—/åœ–ç‰‡| TW1
  S --> L2
  S --> HB
  TS --> BAT
  BAT --> W
  BAT --> S
```

**è¨»è§£ï¼š**

* `watcher.py` è®€å– `config.yaml` çš„ `targets`ï¼Œåœ¨ Chrome ä¸­ç‚ºæ¯å€‹ç›®æ¨™é–‹ä¸€å€‹ **å°ˆç”¨åˆ†é **ï¼Œæ³¨å…¥ `MutationObserver`ï¼ˆç¨± *TeamsWatch*ï¼‰ã€‚
* `TeamsWatch` åªè¦åµæ¸¬åˆ° **æ–°è¨Šæ¯ DOM ç¯€é»**ï¼Œå°±èƒå–æ–‡å­—/ä½œè€…/æ™‚é–“ï¼Œæ¨å…¥ä½‡åˆ—è®“ `watcher.py` å–èµ°ã€‚
* `watcher.py` å°‡äº‹ä»¶ **é™„ä¸Šä¾†æº context**ï¼ˆchatId æˆ– channelId+groupId+tenantIdï¼‰ï¼Œæ‰¹æ¬¡ POST çµ¦ `sender_server.py`ã€‚
* `sender_server.py` ä¾ **ç™½åå–®**ï¼‹**è¦å‰‡å¼•æ“** åˆ¤æ–·æ˜¯å¦å›è¦†ï¼Œä¸¦ç”¨ Selenium æ§åˆ¶ **åŒä¸€å€‹ Chrome** å›åˆ°åŸèŠå¤©/é »é“é€å‡ºè¨Šæ¯ï¼›åŒæ™‚è½åœ°æ—¥èªŒã€‚
* å•Ÿå‹•/å¾©åŸï¼šå¯ç”¨ `start_*.bat` æˆ–åŒ¯å…¥ `task_*.xml` è®“ç³»çµ±ç™»å…¥å¾Œè‡ªå‹•å•Ÿå‹•ï¼Œä¸¦æœ‰å¤±æ•—è‡ªå‹•é‡å•Ÿç­–ç•¥ã€‚

---

## 2) äº‹ä»¶ç”Ÿå‘½é€±æœŸï¼ˆæ™‚åºåœ–ï¼‰

```mermaid
sequenceDiagram
  participant U as ä½¿ç”¨è€…/ä»–äºº
  participant Teams as Teams Web UI
  participant JS as TeamsWatch(MutationObserver)
  participant W as watcher.py
  participant S as sender_server.py
  participant SD as Senderçš„Selenium
  participant C as Chrome

  U->>Teams: åœ¨ç¾¤çµ„/é »é“ç™¼æ–°è¨Šæ¯
  Teams-->>JS: DOM æ–°å¢è¨Šæ¯ç¯€é»
  JS-->>JS: èƒå– sender/text/time/id\næ¨å…¥ __teamsEvents ä½‡åˆ—
  W->>JS: TeamsWatch.fetch()
  JS-->>W: å›å‚³ä¸€æ‰¹äº‹ä»¶
  W->>W: éæ¿¾ SELF_NAMEã€åŠ ä¸Š contextã€å¯« watcher æ—¥èªŒ
  W->>S: HTTP POST /eventï¼ˆå¯æ‰¹æ¬¡ï¼‰
  S->>S: ç™½åå–®æª¢æŸ¥ â†’ è¦å‰‡åŒ¹é… â†’ å†·å»æ™‚é–“
  S->>SD: (é–) ensure_driver()
  SD->>C: é–‹å•Ÿç›¸åŒ chat/channel è¦–åœ–
  SD->>Teams: æ‰¾è¼¸å…¥æ¡† â†’ é€å‡ºæ–‡å­—/åœ–ç‰‡/è¡¨æ ¼åœ–
  Teams-->>JS: DOM å‡ºç¾æ–°è¨Šæ¯ï¼ˆå¯èƒ½æ˜¯è‡ªå·±ï¼‰
  W->>W: å›  SELF_NAME éæ¿¾ã€Œè‡ªå·±ã€â†’ ä¸è§¸ç™¼å›è²
```

---

## 3) watcher.py å­æµç¨‹ï¼ˆå¤šç›®æ¨™ç›£è½ï¼‰

```mermaid
flowchart TD
  A[å•Ÿå‹• watcher.py] --> B[è®€å– config.yaml: watcher.*]
  B --> C[é™„è‘— Chrome(9992) å»ºç«‹ WebDriver]
  C --> D{for ç›®æ¨™ target in targets}
  D -->|æ¯å€‹ target| E[é–‹æ–°åˆ†é â†’å°å‘ Deep Link(&web=1)]
  E --> F[æ³¨å…¥ TeamsWatch JS]
  F --> G{é€±æœŸè¼ªè©¢}
  G --> H[TeamsWatch.alive()? ä¸åœ¨â†’é‡è£]
  H --> I[events = TeamsWatch.fetch()]
  I --> J[é™„åŠ  context(chatId/ channelId..)]
  J --> K[éæ¿¾ SELF_NAME]
  K --> L[å¯« logs/watcher_events.ndjson]
  L --> M[POST /event çµ¦ sender]
  M --> G
```

**è¦é»ï¼š**

* **å­˜æ´»æª¢æŸ¥**ï¼šå®¹å™¨è¢« React é‡æ–°æ¸²æŸ“æ™‚ï¼Œ`TeamsWatch` æœƒå¤±æ•ˆï¼›å®šæ™‚æª¢æŸ¥ `alive()` ä¸¦è‡ªå‹• `install()`ã€‚
* **å¤šåˆ†é éš”é›¢**ï¼šæ¯å€‹ chat/channel 1 å€‹åˆ†é ï¼Œé¿å…äº’æ¶ç„¦é»ã€‚
* **äº‹ä»¶æ ¼å¼**ï¼šåŠ å…¥ `context` å¯è®“ sender å›åˆ°**åŒä¸€å€‹è¦–åœ–**å›è¦†ã€‚

---

## 4) sender\_server.py å­æµç¨‹ï¼ˆè¦å‰‡å¼•æ“ & å¤šç¾¤è·¯ç”±ï¼‰

```mermaid
flowchart TD
  A[å•Ÿå‹• sender_server.py] --> B[è®€å– config.yaml: sender.*, rules]
  B --> C[å•Ÿå‹• HTTP ä¼ºæœå™¨ (/event /health /stats)]
  C --> D{æ”¶åˆ° POST /event}
  D --> E[é€ç­†äº‹ä»¶è™•ç†]
  E --> F[ç™½åå–®æª¢æŸ¥ï¼ˆchatId/channelIdï¼‰]
  F -->|å¦| X[è¨˜éŒ„ skip/deny â†’ çµæŸ]
  F -->|æ˜¯| G[ä¾ rules æ¯”å°: contains/regex/equals...]
  G --> H{å‘½ä¸­è¦å‰‡?}
  H -->|å¦| X
  H -->|æ˜¯| I[å†·å»æ™‚é–“æª¢æŸ¥ï¼ˆrule+scopeï¼‰]
  I -->|æœªéå†·å»| X
  I -->|OK| J[ç”¢ç”Ÿå›è¦†å‹•ä½œ action]
  J --> K[(é–)]
  K --> L[ensure_driver()]
  L --> M{context.kind}
  M -->|chat| N[open_chat(chatId)]
  M -->|channel| O[open_channel(channelId, groupId, ...)]
  N --> P[send_text / send_image / dfâ†’pngâ†’ä¸Šå‚³]
  O --> P
  P --> Q[å¯« logs/sender_actions.ndjson & ç´¯ç©çµ±è¨ˆ]
  Q --> C
```

**è¦é»ï¼š**

* **ç™½åå–®**ï¼šåªå°å…è¨±çš„èŠå¤©/é »é“å›è¦†ï¼Œé¿å…èª¤è§¸ã€‚
* **è¦å‰‡**ï¼šæ”¯æ´ `contains / startswith / equals / regex`ï¼Œå¯åŠ å…¥ `only` é™å®šä¾†æºã€‚
* **å†·å»æ™‚é–“**ï¼šä»¥ã€Œè¦å‰‡ + ä¾†æº(scope)ã€ç‚ºå–®ä½ï¼Œé¿å…æ´—ç‰ˆã€‚
* **ä¸¦ç™¼å®‰å…¨**ï¼šåŒæ™‚å¤šäº‹ä»¶åˆ°é”æ™‚ä»¥é–åºåˆ—åŒ–ã€Œé€è¨Šæ¯ã€éšæ®µï¼Œé˜²äº’æ¶ã€‚
* **è§€æ¸¬æ€§**ï¼š`/health`ï¼ˆæ´»æ€§ï¼‰ã€`/stats`ï¼ˆè¿‘ 1 å°æ™‚è§¸ç™¼çµ±è¨ˆï¼‰ã€‚

---

## 5) å‹•ä½œåˆ†æ”¯ï¼ˆå›è¦†å‹æ…‹ï¼‰

```mermaid
flowchart LR
  A[Action] --> B[æ–‡å­— Text]
  A --> C[åœ–ç‰‡ Image]
  A --> D[è¡¨æ ¼åœ–ç‰‡ DFâ†’PNG]
  C --> C1[æ‰¾åˆ° input[type=file] (å« shadow/iframe)]
  C1 --> C2[send_keys(path) ä¸Šå‚³]
  C2 --> C3[å¯é¸: caption]
  D --> D1[ç”¨ matplotlib å°‡ DataFrame è½‰æˆ PNG]
  D1 --> C1
```

**è¨»è§£ï¼š**

* åœ–ç‰‡ä¸Šå‚³éœ€é€é `<input type=file>`ï¼ŒSelenium `send_keys()` æœ€ç©©ã€‚
* Teams ä¸æ¸²æŸ“ `<img>` HTML æ³¨å…¥ï¼Œå› æ­¤åœ–ç‰‡éœ€èµ°ã€Œé™„ä»¶ã€ã€‚

---

## 6) ä¿æ´»ï¼å®‰å…¨ï¼ç¶­é‹æ¸…å–®

* **å­˜æ´»**ï¼šwatcher ç«¯ `alive()` å®šæ™‚é‡æ›ï¼›sender ç«¯ç¢ºä¿ WebDriver å¯ç”¨ã€å¿…è¦æ™‚é‡æ–°é™„è‘—ã€‚
* **é›™å±¤é˜²å›è²**ï¼šwatcher èˆ‡ sender çš†ä½¿ç”¨ `self_name` éæ¿¾ã€Œè‡ªå·±ã€çš„ç™¼è¨€ã€‚
* **ç™½åå–®**ï¼š`sender.whitelist` åƒ…å…è¨±æŒ‡å®š chat/channelã€‚
* **æ—¥èªŒè¼ªæ›¿**ï¼šè¶…é `rotate_mb` è‡ªå‹•åˆ‡æª”ï¼ˆç°¡å–®æª”æ¡ˆè¼ªæ›¿ï¼‰ã€‚
* **å¿ƒè·³èˆ‡çµ±è¨ˆ**ï¼šsender ç«¯å®šæ™‚å¯«å…¥ heartbeatï¼ˆå¯é¸æ“‡ POST åˆ°è‡ªå®¶ webhookï¼‰ï¼›`/stats` æä¾›è¦å‰‡è§¸ç™¼æ¦‚æ³ã€‚
* **å•Ÿå‹•/è‡ªå‹•é‡å•Ÿ**ï¼š`start_*.bat` ä¸€éµå•Ÿå‹•ï¼›`task_*.xml` ç™»å…¥è‡ªå•Ÿã€å¤±æ•—é‡è©¦ 3 æ¬¡ã€æ¯æ¬¡é–“éš” 60 ç§’ã€‚

---

## 7) äº‹ä»¶ï¼†è¦å‰‡è³‡æ–™çµæ§‹ï¼ˆåƒè€ƒï¼‰

**watcher â†’ sender çš„äº‹ä»¶ï¼ˆç²¾ç°¡ï¼‰ï¼š**

```json
{
  "id": "m_ab12cd34",            
  "sender": "Alice",
  "text": "å ±è¡¨2025-08-30",
  "time": "2025-08-30T01:23:45Z",
  "ts": 1693358625000,
  "context": {
    "kind": "chat",             
    "chatId": "19:...@thread.tacv2",
    "url": "https://teams.microsoft.com/_#/conversations/..."
  },
  "note": "å°ˆæ¡ˆç¾¤"
}
```

**è¦å‰‡ï¼ˆconfig.yaml / rules ç¯€ï¼‰ä¾‹ï¼š**

```yaml
- name: report_date
  when: { regex: "^å ±è¡¨(\\d{4}-\\d{2}-\\d{2})$" }
  reply: { text: "å·²æ”¶åˆ°å ±è¡¨æ—¥æœŸ {g1}ï¼Œé–‹å§‹è™•ç† âœ…" }
  cooldown_sec: 5
```

---

## 8) ä½ˆç½²æ­¥é©Ÿï¼ˆå¿«é€Ÿè¤‡æ ¸ï¼‰

1. ä»¥ `--remote-debugging-port=9992` é™„è‘—åˆ°å·²ç™»å…¥ Teams çš„ Chromeã€‚
2. å¡«å¥½ `config.yaml`ï¼š`watcher.targets`ã€`sender.whitelist`ã€`rules`ã€`self_name`ã€‚
3. å…ˆå•Ÿ `sender_server.py`ï¼ˆçœ‹è¦‹ `listening on http://.../event`ï¼‰ã€‚
4. å†å•Ÿ `watcher.py`ï¼ˆçœ‹åˆ°æ¯å€‹ç›®æ¨™åˆ†é å·²æ‰“é–‹ã€`wired`ï¼‰ã€‚
5. åœ¨ç¾¤çµ„è¼¸å…¥ `#ping`ã€`#help`ã€`#stats` é©—è­‰å›è¦†èˆ‡çµ±è¨ˆã€‚

---

## 9) å¸¸è¦‹å•é¡Œï¼ˆFAQï¼‰

* **ç‚ºä½•æ²’æœ‰æŠ“åˆ°è¨Šæ¯ï¼Ÿ** å…ˆåœ¨ DevTools ç¢ºèªè¨Šæ¯å®¹å™¨çš„ `data-tid` æ˜¯å¦èˆ‡é è¨­ selectors ç›¸ç¬¦ï¼›å¿…è¦æ™‚åœ¨ç¨‹å¼ä¸­è£œä¸Šä½ çš„ç’°å¢ƒ selectorã€‚
* **ç‚ºä½•åœ–ç‰‡æ²’ä¸Šå‚³ï¼Ÿ** æª¢æŸ¥æ˜¯å¦èƒ½åœ¨ DOM ä¸­æ‰¾åˆ° `<input type="file">`ï¼›éƒ¨åˆ† UI éœ€å…ˆé»ã€ŒğŸ“ é™„åŠ ã€æ‰æœƒ mountã€‚
* **ç‚ºä½•è®Šæˆæ›è¡Œè€Œä¸æ˜¯é€å‡ºï¼Ÿ** ä¼æ¥­è¨­å®šè‹¥å°‡ Enter=æ›è¡Œï¼Œç¨‹å¼å·²å‚™æ´ï¼šæ‰¾ã€Œé€å‡ºã€æŒ‰éˆ•é»æ“Šã€‚
* **å¤šç¾¤çµ„åŒæ™‚è§¸ç™¼æœƒè¡çªå—ï¼Ÿ** sender ä»¥é–ä¿è­·é€è¨Šæ¯æ®µï¼Œä¸”æ¯æ¬¡æœƒä¾ `context` å…ˆé–‹åˆ°æ­£ç¢ºè¦–åœ–å†é€å‡ºã€‚
* **å¦‚ä½•æ“´å……è¦å‰‡ï¼Ÿ** å¯åŠ  `only` é™å®šä¾†æºï¼›ä¹Ÿå¯æ–°å¢ `image` æˆ– `df_image` å‹•ä½œï¼ˆéœ€å•Ÿç”¨ pandas/matplotlibï¼‰ã€‚
